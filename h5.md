## h5 Täysin Laillinen Sertifikaatti


### x) Lue/katso ja tiivistä. (Tässä x-alakohdassa ei tarvitse tehdä testejä tietokoneella, vain lukeminen tai kuunteleminen ja tiivistelmä riittää. Tiivistämiseen riittää muutama ranskalainen viiva kustakin artikkelista. Kannattaa lisätä myös jokin oma ajatus, idea, huomio tai kysymys.)
  
  #### OWASP 2021: OWASP Top 10:2021
    - A01:2021 – Broken Access Control (IDOR ja path traversal ovat osa tätä)
    - A10:2021 – Server-Side Request Forgery (SSRF)

  #### PortSwigget Academy:
    - Insecure direct object references (IDOR)
    - Path traversal
    - Server-side template injection
    - Server-side request forgery (SSRF)
    - Cross-site scripting

  #### Karvinen 2020: Using New Webgoat 2023.4 to Try Web Hacking


------------------------------------------------------------

### a) Totally Legit Sertificate. Asenna OWASP ZAP, generoi CA-sertifikaatti ja asenna se selaimeesi. Laita ZAP proxyksi selaimeesi. Laita ZAP sieppaamaan myös kuvat, niitä tarvitaan tämän kerran kotitehtävissä. Osoita, että hakupyynnöt ilmestyvät ZAP:n käyttöliittymään. (Ei toimi localhost:lla ilman Foxyproxya)

#### Asenna OWASP ZAP.
Aloitin tehtävän asentamalla Zaproxy eli ZAP. Tätä ehdittiin jo tunnilla käydä läpi ja tapoja oli muutama. Joko suoraa paketinhallinnan kautta kuten alla tai vaihtoehtoisesti ZAPin omilta lataus sivuilta - [Download ZAP](https://www.zaproxy.org/download/). Sivuilta löytyy installer versio ja packet versio.  

    $ sudo apt-get install zaproxy

![image](https://github.com/AArmias/pentest/assets/102689055/73159058-5c05-4bce-bb0d-fe70ec391098)

Kas näin, nyt meillä on ZAP asennettuna. 

![image](https://github.com/AArmias/pentest/assets/102689055/45eead64-b3dc-47d1-8e8f-d7e0dde18215)

#### Generoi CA-sertifikaatti ja asenna se selaimeesi.
Nyt CA-sertifikaatin pariin. Tämä osuus käytiin yhdessä tunnilla läpi, joten asetuksen säätämiseen ei tarinnut kaivella nettiä läpi. Asetus löytyy `Options -> Network -> Server Certificates` tai `Options` ja hakukenttään `Certificates`.

![image](https://github.com/AArmias/pentest/assets/102689055/11bbf62c-c337-4ddd-93b0-48444552a8fb)


HUOM! Aiemmin tämä asetus löytyi kohdasta `Dynamic SSL Certificates` mutta nyt siellä on seuraava ilmoitus ja linkki eteenpäin: 

![image](https://github.com/AArmias/pentest/assets/102689055/127f1d4b-2c9c-44e4-a1fc-b279d742c0a6)

Painetaan generate.

![image](https://github.com/AArmias/pentest/assets/102689055/a71ec629-273f-4302-887c-3dc57e6e545e)

Yes. 

Valitaan Save ja tallennetaan sertifikaatti. 

![image](https://github.com/AArmias/pentest/assets/102689055/a146f75b-1ba6-4f6e-86c1-2c91ff27bdc5)

Nyt meillä on CA sertifikaatti luotuna, lisätään se firefoxiin. 

Käynnistetään firefox ja otetaan oikealta kulmasta valikko auki. Settings -> Privacy - Security -> Certificates -> View Certificates ja Import... 

![image](https://github.com/AArmias/pentest/assets/102689055/56bb23c1-7353-467c-a226-ed8fcd94c399)

![image](https://github.com/AArmias/pentest/assets/102689055/9be23097-08ac-4927-80cc-d97d6dc70ccb)

Etsitään kotihakemistosta aiemmin tallennettu sertifikaatti `zap_root_ca.cer` -> Open


`Trust this CA to identify websites.` -> OK 
![image](https://github.com/AArmias/pentest/assets/102689055/a3076eca-bbb1-4bf0-992e-97b325d37b73)

![image](https://github.com/AArmias/pentest/assets/102689055/71a89237-3445-42a5-8c3c-117535a14b59)

Sieltä löytyy! 

#### Laita ZAP proxyksi selaimeesi.

Avataan Firefoxin asetukset: Settings -> General -> Network Settings -> Settings...
![image](https://github.com/AArmias/pentest/assets/102689055/3cbca2d9-3640-4365-bf15-e2d03df5ee47)

Asetetaan manuaalisesti osoitteeksi `localhost` ja portiksi `8080` jossa ZAProxy operoi. -> OK. 

![image](https://github.com/AArmias/pentest/assets/102689055/9c13a91c-d4d0-428d-9ec5-fefe2a9afbfa)

Kokeillaan avata wikipedia ja katsotaan toimiiko Zap. 

![image](https://github.com/AArmias/pentest/assets/102689055/6d055c87-4fcd-4b80-95e4-0e0546312177)


Zap toimii selaimessa!  


#### Laita ZAP sieppaamaan myös kuvat. 

Asetus löytyy Options -> Display -> `Process images in HTTP requests/responses` merkki ruutuun ja OK. 

![image](https://github.com/AArmias/pentest/assets/102689055/9befc589-a513-4444-9291-33dc290ed3ca)

#### Osoita, että hakupyynnöt ilmestyvät ZAP:n käyttöliittymään.

Avattiin Reddit ja päällä oli Zapin Safemode kaiken varalta. Liikenne näkyi Zapin puolella heti. 

![image](https://github.com/AArmias/pentest/assets/102689055/887d38db-4b7f-4e27-bbcc-0ad2f3c4da0e)

-------------------------------------------------------------------------------------------------


### b) Kettumaista. Asenna FoxyProxy Standard Firefox Addon, ja lisää ZAP proxyksi siihen. Käytä FoxyProxyn "Patterns" -toimintoa, niin että vain valitsemasi weppisivut ohjataan Proxyyn. (Läksyssä ohjataan varmaankin PortSwigger Labs ja localhost.)

FoxyProxy on selainlaajennus joten se löytyy sieltä mistä firefoxin muutkin selainlaajennukset eli addonit on saatavilla. Tarjolla on useampi vaihtoehto, nyt ohjeena oli asentaa standard versio. 

![image](https://github.com/AArmias/pentest/assets/102689055/db5bc9cc-f5a8-4940-b256-8ed9d0bebd75)

Standar versio löytyi ja asennetaan se. 

![image](https://github.com/AArmias/pentest/assets/102689055/043aa0c0-7a49-405e-a466-5a4b991bb15d)

Laitetaan ZAPorxyn asetukset FoxyProxyyn. 
Nimi: ZAP, Hostname: Localhost, Port 8080 samat jotka löytyvät Zapin alereunasta. 

![image](https://github.com/AArmias/pentest/assets/102689055/5fdd9b99-7367-450b-8c54-ff0b0918f3a9)

![image](https://github.com/AArmias/pentest/assets/102689055/705f1d1e-f971-4403-b37f-e05754fec407)

#### Käytä FoxyProxyn "Patterns" -toimintoa, niin että vain valitsemasi weppisivut ohjataan Proxyyn.
Koska Patternsit asetetaan suoraa käytössä olevalle proxylle (ZAP), löytyy Patterns asetukset FoxyProxyn omista asetuksista `Proxies` välilehdeltä ZAPorxyn asetuksien alta. 
Lisätään: "(Läksyssä ohjataan varmaankin PortSwigger Labs ja localhost.)". 

![image](https://github.com/AArmias/pentest/assets/102689055/1f2e000b-58fd-40f7-a08d-25e56044b371)

Otetaan Foxyproxyn profiilista `Proxy by Patterns` profiili käyttöön. 

![image](https://github.com/AArmias/pentest/assets/102689055/f1335bed-5bdc-46fe-a13e-68a04c339e4e)

Nyt kun päivitetään 2 selainta, toinen jossa on Reddit ja toinen jossa on Portswigger, ei reddit:n get pyynnöt tule enää läpi, ainoastaan Portswiggerin pyynnöt. 

![image](https://github.com/AArmias/pentest/assets/102689055/ba771ba5-090a-4a0f-adf4-fe1789c14242)

Lisätään vielä Portswigger LAB ja otetaan tuo Portswigger epäaktiiviseksi. 

![image](https://github.com/AArmias/pentest/assets/102689055/0d79fb38-1467-4499-8670-beb376caab66)

Noin, nyt se toimii labihommissa! 

---------------------------------------------------------

### PortSwigger Labs. Ratkaise tehtävät. Selitä ratkaisusi: mitä palvelimella tapahtuu, mitä eri osat tekevät, miten hyökkäys löytyi, mistä vika johtuu. Kannattaa käyttää ZAPia, vaikka malliratkaisut käyttävät harjoitusten tekijän maksullista ohjelmaa. Malliratkaisun kopioiminen ZAP:n tai selaimeen ei ole vastaus tehtävään, vaan ratkaisu ja haavoittuvuuden etsiminen on selitettävä ja perusteltava.

### Insecure Direct Object Reference (IDOR)
#### c) Insecure direct object references
![image](https://github.com/AArmias/pentest/assets/102689055/ac2dc0e4-e3c9-4ff0-be38-c365e2c335c4)

Ensimmäinen tehtävä ja suoraa syvään päähän. Koska murtautumista ei ole tullut kurssin kotitehtäviä lukuunottamatta harjoiteltua on lähtökohdat aika olemattomat. Lisäksi käytössä on jälleen uusi työkalu. 
Tutkittuani ensin sivustoa aikansa ja pyöriteltyä Zappia ympäriinsä, oli helppo todeta että apua tarvitaan. Koska Zap ei ollut tuttu ohjelma käyttää, ei mallivastaus juuri vienyt eteenpäin. 
Hahmotin kyllä tässä kohtaa sen mitä pitäisi tehdä, mutta en sitä miten se onnistuu Zapissa. Kuten ohjeessa kerrottiin sivusto tallentaa chatlogit suoraa serverille ja pyytää niitä staattisilla urleilla. 
Tässä tapauksessa avain löytyy siitä, että jokainen chat logi kasvaa yhdellä numerolla. Ensimmäinen logi on 1.txt, toinen 2.txt jne... Pyydettäessä logia, järjestelmä siis pyytää keskustelun logia seuraavasti:

    GET https://0ad2006b0395667d80a194cb00b10062.web-security-academy.net/download-transcript/1.txt HTTP/1.1
    host: 0ad2006b0395667d80a194cb00b10062.web-security-academy.net
    User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0
    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
    Accept-Language: en-US,en;q=0.5
    Connection: keep-alive
    Referer: https://0ad2006b0395667d80a194cb00b10062.web-security-academy.net/chat
    Cookie: session=KZNtUFlnxahGK7HfhGRY8uyZkubmOuJx
    Upgrade-Insecure-Requests: 1
    Sec-Fetch-Dest: document
    Sec-Fetch-Mode: navigate
    Sec-Fetch-Site: same-origin
    Sec-Fetch-User: ?1
    content-length: 0

ja vastaa siihen.

    HTTP/1.1 200 OK
    Content-Type: text/plain; charset=utf-8
    Content-Disposition: attachment; filename="2.txt"
    X-Frame-Options: SAMEORIGIN
    Connection: close
    Content-Length: 520


Kuitenkin vasta katsottuani Michael Sommerin videon [Insecure direct object references](https://www.youtube.com/watch?v=Sd8jL96H0hc&t=5s) Pääsin kiinni ajatukseen ja siihen, että Zapista pitää löytää tarvittava työkalu pyyntöjen katkaisemiseksi ja minipuloimiseksi. 
Tämä lopulta löytyi ja tämän avulla tehtävän ratkaiseminen oli huomattavasti helpompaa. Yläpalkista löytyvä vihreä pallo `Set Break on All Request and Responses` katkaisee pyynnöt, mahdollistaa niiden lukemisen ja muokkaamisen matkalla. 


Nyt kun työkalu on hallussa ja ajatus siitä mitä pitäisi tehdä on olemassa, voidaan kokeilla ratkaista tehtävä. 
Kokeillaan pysäyttää pyynnöt ja muokata tuota responsea hieman. Vaihdetaan `2.txt` muotoon `1.txt`.

    HTTP/1.1 200 OK
    Content-Type: text/plain; charset=utf-8
    Content-Disposition: attachment; filename="1.txt"
    X-Frame-Options: SAMEORIGIN
    Connection: close
    Content-Length: 520

mennään yksi pyyntö eteenpäin ja huomataan, että meille aukenee Carloksen? (You) ja Halin keskustelu. Carlos? (You) on kaikkia tietoturvan lakeja vastaan päättänyt kysellä chatissa Halilta muistaako hän oikein salasanansa ja kertoo tietysti koko salasanan. 
Nyt kun tämä informaatio on jäänyt chat logiin talteen, voidaan kokeilla hyödyntää sit. 

![image](https://github.com/AArmias/pentest/assets/102689055/ae24ca01-3e55-4eb7-9681-54ab6dae8f09)

Kokeillaan löytyikö chat keskustelusta oikea salasana. 

![image](https://github.com/AArmias/pentest/assets/102689055/4e95ccea-5a9a-43bc-bcba-4a6cf0178267)

Löytyi! 

![image](https://github.com/AArmias/pentest/assets/102689055/29aadb65-5ec2-43bb-a1ce-0b0245dd83f5)

------------------------------------------------------------

### Path traversal
#### d) File path traversal, simple case
![image](https://github.com/AArmias/pentest/assets/102689055/914e4cea-886c-4ab5-8298-982cac69bd5d)

Kuten ohjeistus kertoo, tehtävässä on tuotekuvien näyttämiseen liittyvä haavoittuvuus, joka mahdollistaa läpikulun. Info antaa myös jo suuren vinkin siitä, miten tehtävää tulisi lähestyä. 
ZAP Tuli myös edellisess tehtävässä tutuksi, joten nyt tiedetään miten requestit pysäytetään. Tarkastellaan siis pyyntöjä. 

    GET https://0a5f00240403186185848b3b00ab0034.web-security-academy.net/image?filename=23.jpg HTTP/1.1
    host: 0a5f00240403186185848b3b00ab0034.web-security-academy.net
    User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0
    Accept: image/avif,image/webp,*/*
    Accept-Language: en-US,en;q=0.5
    Connection: keep-alive
    Referer: https://0a5f00240403186185848b3b00ab0034.web-security-academy.net/product?productId=1

ja response:

![image](https://github.com/AArmias/pentest/assets/102689055/7c87bb54-6585-46ac-b5f1-21de9a024ea3)


Tuotteeseen mentäessä sivusto avaa tuotten tiedot (teksti) ja lähettää pyynnön tuotekuvasta `GET https://0a5f00240403186185848b3b00ab0034.web-security-academy.net/image?filename=23.jpg`
Koske meillä oli tiedossa, että tuotekuviin liitty haavoittuvuus pyritään tietysti manipuloimaan tuota tuotekuvan polkua. Vihjeeksi on annettu tiedosto polun pää, eli `/etc/passwd`.
Kokeillaan `GET https://0a5f00240403186185848b3b00ab0034.web-security-academy.net/etc/passwd` Ei toimi ja Fail iilmotusta puskee.

Luetaan uudelleen vihje ja katsotaan mitä [What is path traversal?](https://portswigger.net/web-security/file-path-traversal) kertoo meille.

Läpikulku. hmm. Kokeillaanpa ohjeissa ollutta esimerkki polkua. 

`GET https://0a5a00780470f9ae825dcf22009f005c.web-security-academy.net/image?filename=../../../etc/passwd`

Hämmentävää, mitään virheilmoitusta ei tule, itseasiassa ei mitään ilmoitusta mihinkään. Muuttuiko mikään? 

Lähemmin tarkasteltuna, responsessa pitäisi näkyä tuo kuva mitä haettiin. Koska pyyntö hieman muutettiin, kuvaa tuskin tulee takaisin. 

![image](https://github.com/AArmias/pentest/assets/102689055/b406ca85-e665-4b69-98ac-9a4d9987071c)

Vaihdetaan body:imagesta -> tekstiksi 

![image](https://github.com/AArmias/pentest/assets/102689055/1c4d34ed-f546-49fa-8d0f-1bbd2bfa0011)

Kokeillaan samaa oikealle kuva pyynnölle. 

![image](https://github.com/AArmias/pentest/assets/102689055/6bf3c3cb-9ec8-41b9-8b95-274ee531ae92)

Kyllähän siellä siis hieman erillaista tieto tuli meille takaisinpäin. 

Kokeillaan päivittää sivu. 

![image](https://github.com/AArmias/pentest/assets/102689055/c607f932-0b0b-4687-8afd-bf4c63a3af29)

Tehtävä tehty onnistuneesti, vaikkakin hieman jäi hämmentämään kuitenkin lopputulos. 

----------------------------------

#### e) File path traversal, traversal sequences blocked with absolute path bypass

![image](https://github.com/AArmias/pentest/assets/102689055/7ba6d07d-1098-4586-b117-37b8eef6ae05)

Erona edelliseen tehtävään on se, että nyt ei pitäisi olla mahdollista kulkea läpi. Mahdollista on kuitenkin hyödyntää aukkoa liittyen oletustyöhakemistoon ja tiedostonimeen. 

Kokeillaan siis pysäyttää taas pyynnöt ja sovittaa tuota `/etc/passwd` jonnekkin väliin. 

    GET https://0a2f008a03be8615801b8f0c00b700dc.web-security-academy.net/image?/etc/passwd HTTP/1.1
    host: 0a2f008a03be8615801b8f0c00b700dc.web-security-academy.net
    User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0

Antaa virhe ilmoituksen puuttuvasta Filenamesta. No lisätään se sinne. 

`GET https://0a2f008a03be8615801b8f0c00b700dc.web-security-academy.net/image?filename=/etc/passwd`

Ei virheilmoitusta ja Responsekin muistuttaa edellisen tehtävän responsea:

![image](https://github.com/AArmias/pentest/assets/102689055/28ac2437-4ca8-4d71-8fbf-3edbf063b9df)

päivitetään siis sivu.
 
![image](https://github.com/AArmias/pentest/assets/102689055/646a5956-9b2d-438d-9776-6d9a77953824)

Tehtävä onnistui, mikäli tästä tehtävästä olisi pitänyt aloittaa. Olisi tuo vastaus ollut melkein helpommin oikein kuin ekassa, jossa tiedostopolku piti lisätä. 


------------------------------------

#### f) File path traversal, traversal sequences stripped non-recursively

![image](https://github.com/AArmias/pentest/assets/102689055/311bd534-a8f7-4724-9d00-6950941fe1ba)

Saman tyyppinen tehtä kuten aiemmin. Tässä tapauksessa kuitenkin läpikulku sekvessit poistetaan tiedostonimestä. eli ./ katoaa pois. 
Ekan tehtävän kohdalla ohjeita ja eri tapoja katsellessa, mieleen jäi kohta kappaleesta [Common obstacles to exploiting path traversal vulnerabilities](https://portswigger.net/web-security/file-path-traversal#common-obstacles-to-exploiting-path-traversal-vulnerabilities) `"You might be able to use nested traversal sequences, such as ....//`", pienellä intuitiolla päätin tutkia enemmän vielä tätä ja vastaan tuli teksti `"….// is a basic nested traversal sequence. It effectively bypasses the defense outlined above, by using the defense against itself. The application strips the inner file path traversal sequence defensively, but leaves a remaining ../,"` - [Using Nested Traversal Sequences to Bypass File Path Traversal Defense](https://kadalonsecurity.medium.com/using-nested-traversal-sequences-to-bypass-file-path-traversal-defense-3982feb4e60b)

Melko hyvällä fiiliksellä tämän jälkeen päätin kokeilla tuota.  

![image](https://github.com/AArmias/pentest/assets/102689055/d6f61070-bbfd-460a-bae1-2f3b392cd456)

TSADAAA! Onnistui!

![image](https://github.com/AArmias/pentest/assets/102689055/c71e74da-61da-4d03-b9b2-be5cc99e63f1)

![image](https://github.com/AArmias/pentest/assets/102689055/da4dd528-8c02-4e43-ad2d-e3866f1d208c)

Tämän viimeisen tehtävän kohdalla tuli ekaa kertaa sellainen olo, että tiesi jo valmiiksi mitä nyt haetaan ja ymmärsi homman.

-------------------------------------

### Server Side Template Injection (SSTI)
#### g) Server-side template injection with information disclosure via user-supplied objects (Tämä on merkitty hieman vaikeammaksi, jätä viimeiseksi jos näyttää hankalalta)
Server Side Request Forgery (SSRF)

![image](https://github.com/AArmias/pentest/assets/102689055/055fdcf9-b7ca-4e20-ad9e-c8f68086b58e)

Tehtävän avattuani ja "What is server-side template injection?" ohjeistusta luettuani, huomasin olevani jo valmiiksi melko kuormittunut kaikista aiemmista tehtävistä. 
Uteliaisuus kuitenkin kasvoi ja halusin tutustua tehtävään hieman paremmin. Aiemmissa tehtävissä oli käytetty kuva pyynnöstä löytynyttä haavoittuvuutta, nyt oltiinkin ihan eri päässä. 
Koska tehtävä osoittautu todella hankalaksi, tutkin mallivastausta ja ymmärsin heti, että lähtö tietotaito riittää nipin napin ohjeen mukaan läpipääsemiseen. 
Koska djangoa ei ole tullut käytännössä yhtään käytettyä, kielen nyanssit ja komennot ovat melko kaukaisia. Sain kuitenkin ajatuksesta kiini. Tehtävässä pyritään hyödyntämään djangon haavoittuvuutta.

Ratkaisussa ohjeistetaan lisäämään `{% debug %}` rivi editoitavaan kuvaukseen ja tallentamaan se. Tämä näyttää kaikki komennot ja ominaisuudet joihin on pääsyt. Tärkein näistä on kuitenkin `settings`. Lista on todella pitkä ja mikäli tosiaan djangosta ei tiedä mitään, olisi tuo `settings` ominaisuuden löytäminen melko mahdotonta. 
![image](https://github.com/AArmias/pentest/assets/102689055/c8aba7ea-59ef-4f4b-aa15-56533984cbbd)

Ratkaisu käskee liäämään `{% debug %}` perään `{{settings.SECRET_KEY}}` jolloin debug moodissa ilmeisesti pyydetään `settings` objektia hyödyntäen tulostamaan `SECRET_KEY`. 
![image](https://github.com/AArmias/pentest/assets/102689055/09457506-ce36-4135-b440-80f3ccac7c2c)

![image](https://github.com/AArmias/pentest/assets/102689055/9f7c0274-9f1a-484f-b18e-c0870b8c9865)

Syötetään tuo viimeinen rimpsu ja tehtävä on ratkaistu. 

![image](https://github.com/AArmias/pentest/assets/102689055/1b6fc88d-a881-449d-a74a-a3521d13e63e)

Tässä tehtävässä huomaa miten suuri etu on jonkin tietyn kielen, sovelluksen tai käyttöympäristön osaamisella todella hyvin. 
Itselläni olisi varmasti vierähänyt useampi viikko löytää nämä ratkaisun vaatimat kohdat, mikäli olsin oikealle tielle edes päässyt. 

-----------------------------------------------------------

#### h) Basic SSRF against the local server

![image](https://github.com/AArmias/pentest/assets/102689055/e19ac6fb-2a52-46a7-8109-b91377abb2a0)

Tehtävä hieman jännitti edellisen jälkeen. Luettuani tehtävän kuvauksen ja ohjeistuksen "What is SSRF" (https://portswigger.net/web-security/ssrf#what-is-ssrf). Tuli kuitenkin hyvä fiilis.
Ymmärsin heti miten lähestyä ratkaisua. 

Zap valmiiksi nappaamaan pyyntöjä ja `Check Stock`. 
![image](https://github.com/AArmias/pentest/assets/102689055/f74bbffc-b0ce-46b6-9379-3597ddbf4a27)

Eikä aikaakaan kun Zap tarjoilee `stockApi=` kutsua. Tästä alkuperäinen "stockin tarkistus" (varastossa olevien tuotteiden määrä) pois ja tilalle `http://localhost/admin`. 
Zapin pyyntöjen nappaus pois päältä ja tarkistamaan onnistuiko. 

![image](https://github.com/AArmias/pentest/assets/102689055/4e552357-0199-4eb0-87b9-d908bdcc73a5)

Sivun alareunaan oli ilmestynyt tälläinen: 

![image](https://github.com/AArmias/pentest/assets/102689055/43af5a68-8897-4c86-8da6-58662e929757)

Olisi liian helppoa jos pelkästään `delete` nappia painamalla homma olisi ohi. 

![image](https://github.com/AArmias/pentest/assets/102689055/d17420e0-26f6-46f9-9c29-f9b66a78a3bd)

Delete napin pyyntö näytti tältä:

    GET https://0a6f00b20316fc3b81451b9f00a60062.web-security-academy.net/admin/delete?username=carlos HTTP/1.1
    host: 0a6f00b20316fc3b81451b9f00a60062.web-security-academy.net
    User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0
    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
    Accept-Language: en-US,en;q=0.5

ja Response tältä:

    HTTP/1.1 401 Unauthorized
    Content-Type: text/html; charset=utf-8
    X-Frame-Options: SAMEORIGIN
    Connection: close
    Content-Length: 2674

Tässä kohtaa pitää siis hyödyntää taas stockApia ja samaa haavoittuvuutta. 

![image](https://github.com/AArmias/pentest/assets/102689055/0c80f32a-759b-4578-b697-1450d8cc6da5)

Carlos poistettu ja tehtävä paketissa. 

![image](https://github.com/AArmias/pentest/assets/102689055/0264ba4d-9b68-4e0c-bcfb-691ca79c593b)

--------------------------------------------

### Cross Site Scripting (XSS)
#### i) Reflected XSS into HTML context with nothing encoded

![image](https://github.com/AArmias/pentest/assets/102689055/139ff837-821d-41d7-a9d3-b5dbdcdd20f3)

Tehtävän kuvaus ei vaikuta mahdottomalta, mutta alettuani lukemaan ohjeistusta "What is XSS" homman laajuus kuitenkin avautui. 
Lisäksi katsoin läpi [alert() is dead, long live print()](https://portswigger.net/research/alert-is-dead-long-live-print) 
Jonka innoittaman päätin kokeilla hakukenttään tuota `<script>alert()</script>`.

![image](https://github.com/AArmias/pentest/assets/102689055/fab3d6e1-12db-483e-8004-16abdd897439)


![image](https://github.com/AArmias/pentest/assets/102689055/4c252357-a801-414b-a394-4c2ca21b47bb)

Homma ratkaistu! 

------------------

#### j) Stored XSS into HTML context with nothing encoded

![image](https://github.com/AArmias/pentest/assets/102689055/7be81530-7427-407a-87bb-9eb546b6d3ac)

Hieman saman tyylinen tehtävä siis luvassa, kuin tuo aikaisempikin. Tällä kertaa kuitenkin haavoittuvuus löytyy http pyynnöstä. 
Zap siis tulille ja keräämään pyynnöt talteen. Kirjoitetaan blogiin kommentti ja lähetetään se. 
Zap nappaa tuon post pyynnön talteen. Muutetaan tuota pyyntöä hieman ujuttamalla edellisen tehtävän `<script>alert()</script>` kommentti osion tilalle ja annetaan pyyntöjen jatkua normaalisti.

![image](https://github.com/AArmias/pentest/assets/102689055/367113a4-d277-4f3f-9dcf-d6ca4edafeeb)

Tehtävä ratkaistu. Zapin avulla siis pyyntö talteen, pyyntöön pieni hienosäätö ja ujutetaa harmillinen skriptin pätkä kommenttina järjestelmään. 

![image](https://github.com/AArmias/pentest/assets/102689055/521e4622-1938-4473-94bc-6b50049c649f)


---------------------------

### k) Asenna Webgoat 2023.4. (Uusi versio, jossa on eri tehtäviä kuin vanhemmissa. Jos olet jo asentanut sen, ei tarvitse raportoida asennusta uudelleen; raportoi silloin vain pelkkä testi, jolla toteat sen toimivaksi.)

Olimme ensimmäisessä kotitehtävässä asentanteet vanhemman Webgoat version, joten uuden version asentaminen oli edessä. 
Ohjeet asennukseen löytyi Tero karvisen julkaisusta: [Try Web Hacking on New Webgoat 2023.4](https://terokarvinen.com/2023/webgoat-2023-4-ethical-web-hacking/).

Normaali lähtötapa eli paketit päivitykseen: 
    
    $ sudo apt-get update
Lisäksi asennetaan java laajennus, mikäli sitä ei ole:     
    
    $ sudo apt-get install openjdk-17-jre
Itsellä tällä kertaa java laajennus oli valmiina. 

![image](https://github.com/AArmias/pentest/assets/102689055/fa2a4549-b1f2-421e-ad5d-af18b21bf02e)

Palomuurin asennus ja käynnistys, mikäli sitä ei ole tehnyt: 

    $ sudo apt-get install ufw
    $ sudo ufw enable

Itselläni palomuuri jo kävi ja kukkui valmiiksi. 

![image](https://github.com/AArmias/pentest/assets/102689055/7d20dec8-72f8-4da0-ba6f-abaddb1fb134)

Mikäli wget ei ole asennettuna on se hyvä tehdä tässä vaiheessa: 

    $ sudo apt-get install wget

sekin löytyi tällä kertaa jo valmiiksi. 

![image](https://github.com/AArmias/pentest/assets/102689055/926dcb3c-2bd2-40cb-83bc-5acae366ba1e)

Sitten Webgoat 2023.4. paketin lataus: 

    $ wget https://github.com/WebGoat/WebGoat/releases/download/v2023.4/webgoat-2023.4.jar

![image](https://github.com/AArmias/pentest/assets/102689055/1b5ad8b8-3edf-40f6-9e9d-b28f966a8a9f)

Koska Webgoat harjoituksia tehdessä koneella tullaan saman aikaisesti ajamaan ZAP välimiesproxyä, joka käyttää porttia 8080 samoin kuin Webgoat tekisi, vaihdetaan WebGoatin portti 8888 ja Webwolfin 9090. 
Samalla käynnistetään Webgoat käyttöä varten. 

    $ java -Dfile.encoding=UTF-8 -Dwebgoat.port=8888 -Dwebwolf.port=9090 -jar webgoat-2023.4.jar

![image](https://github.com/AArmias/pentest/assets/102689055/e0720e62-4cc9-43fb-b879-5526512bd2d6)

Mikäli asennus on onnistunut nyt meillä pitäisi olla WebGoat päällä. Tarkistetaan se menemällä osoitteeseen: `http://127.0.0.1:8888/WebGoat`

![image](https://github.com/AArmias/pentest/assets/102689055/40e12dbf-83f9-4be2-a920-e24cede44446)

Käynnissä on. 

Nyt vuorossa on käyttäjän luonti ja harjoituksen aloitus. 

![image](https://github.com/AArmias/pentest/assets/102689055/c2ebf509-8890-4bf5-8f44-8068f1225d30)

![image](https://github.com/AArmias/pentest/assets/102689055/f2bf0e24-50ea-4339-9802-7b16d9cb569d)


----------------------------------------------------------------------------------------------------

### l) Asenna pencode ja muunna sillä jokin merkkijono (encode a string).

Jotta sain asennettua pencoden tuli ensiksi asentaa paketillinen Go ohjelmointikieltä. 

    sudo apt-get -y install golango-go
  Testataan myös asennuksen jälkeen löytyykö kieli nyt: 

    go version
![image](https://github.com/AArmias/pentest/assets/102689055/8ba66eba-3793-4f10-b628-a0a2943f7458)

Nyt githupista löytyvät asennus ohjeet toimivat: 

    go install github.com/ffuf/pencode/cmd/pencode@latest

![image](https://github.com/AArmias/pentest/assets/102689055/a49ac306-cc14-4848-9589-47b4791e5dc0)

------------------------------------------------------------------

### Ratkaise WebGoat 2023.4:

#### n) (A7) Identity & Auth Failure (WebGoat 2023.4)
    - Authentication Bypasses (1)
Tehtävän esittelyssä kerrotaan tapauksesta jossa Paypalista oli löytynyt haavoittuvuus, jossa sisälle oli mahdollista kirjautua turvakysymyksiä hyödyntäen, poistamalla kirjautumisen POST pyynnöstä nuo turvakysymykset vallan.
Tehtävässä siis kierretään todennus. Todennuksen kiertämiseen on eri vaihtoehtoja yleisesti kuitenkin jonkun tyyppinen manipulointi. Tässä tehtävässä poistetaan parametrejä, joka mahdollistaa todennuksen kiertämisen. 
Vihjeenä oli, että melkein sama ratkaisu kun paypal tarinassa, mutta ei kuitenkaan. 
Zap päälle ja tutkimaan. Annetaan turvakysymyksiin arvaukset 5555 molempiin. 

![image](https://github.com/AArmias/pentest/assets/102689055/d903c3cc-6c59-4f89-860d-d0117333f7b5)

Nyt saadaan kirjautumisen POST pyyntö tarkasteluun: 
    
    secQuestion0=5555&secQuestion1=5555&jsEnabled=1&verifyMethod=SEC_QUESTIONS&userId=12309746

Kokeillaan poistaa kaikki turvakysymykseen liittyvä. 

    verifyMethod=userId=12309746

Ei toiminut ollenkaan.

    "status" : 400,
    "error" : "Bad Request",

Tässä vaiheessa kokeilin 5-6 eri versiota. Kunnes lopulta löytyi toimiva versio. 
Jotta tehtävän sai suoritettua, ei saanut poistaa turvakysymyksiä vaan piti manipuloida niitä hieman.
Mikäli ne poisti, tuli aina `"Bad Request"`. Mutta kun `secQuestion0` muutti muotoon `secQuestion00` ja 
`secQuestion1` muotoon `secQuestion11`. Oli vastaus onnistunut. 
Piti siis tehdä turvakysymys jota ei oikeasti ole olemassa, jotta pyyntö meni täydestä järjestelmälle. 

    "lessonCompleted" : true,
    "feedback" : "Congrats, you have successfully verified the account without actually verifying it. You can now change your password!",
    "output" : null,
    "assignment" : "VerifyAccount",
    "attemptWasMade" : true

![image](https://github.com/AArmias/pentest/assets/102689055/a6cdbd98-5c88-4ad5-bc7b-7cbd34f6ee6c)


    - Insecure Login (1)
Tässä tehtävässä pureudutaan salauksen tärkeyteen tietoturvassa. Ohjeena on käyttää packet snifferiä kirjautumistietojen nappaamiseen. Zap käyttöön. 
Zap päälle ja painetaan Log in nappia. 

![image](https://github.com/AArmias/pentest/assets/102689055/7661d07a-78f8-4f54-a391-5fc5e649dcec)

Kirjautumisen POST pyyntö: 

![image](https://github.com/AArmias/pentest/assets/102689055/622827ad-7d32-4640-a484-d1309b36b5f6)

Täytetään ohjeen mukaisesti `username=CaptainJack` ja `password=BlackPearl` saaduilla tiedoilla ja painetaan `Submit`.

![image](https://github.com/AArmias/pentest/assets/102689055/1eae26f9-9501-4ff7-95b6-76630f797a4a)


#### o) (A10) Server-side Request Forgery (WebGoat 2023.4)
    - Server-Side Request Forgery (2)
Näissä kahdessa tehtävässä keskitytään palvelinpuolen pyyntöjen väärentämiseen. 
Zap avuksi ja painetaan ensimmäisen tehtävän `Steal the Cheese` painiketta. 

![image](https://github.com/AArmias/pentest/assets/102689055/7112d871-2c42-4d4b-88d5-9a283b9e069d)

Post pyyntö pitää sisällään rivin:

    url=images%2Ftom.png

Koska ohje oli: "Find and modify the request to display Jerry"

Kokeillaan niinkin yksinkertaista tapaa, kun vaihtaa tom -> jerryksi. 

    url=images%2Fjerry.png

![image](https://github.com/AArmias/pentest/assets/102689055/300ca8be-0e88-4bbd-982d-e6b5abf0b833)

Toinen osa:
Painetaan Try this nappia ja katsotaan minkälainen POST pyyntö tulee nyt Zappiin. 

![image](https://github.com/AArmias/pentest/assets/102689055/4b8a6ecc-e0b6-4809-9976-e0a9ce4ae7f5)

POST pyyntö: 

    url=images%2Fcat.png

Noudatetaan tehtävän antoa ja vaihdetaan urliksi `url=http://ifconfig.pro`

![image](https://github.com/AArmias/pentest/assets/102689055/62a05cb1-4438-4ab6-ac78-67c45e8df036)

Onnistui, nyt tulostellaan kissojen sijaan, oma ip osoitteeni ja palveluntarjoajani. 


#### p) Client side (WebGoat 2023.4)
    - Bypass front-end restrictions (2)
Tehtävässä tulisi osata HTML koodia ja hyödyntää tämän muokkausta selaimella. Tehtävä osoittautui itselle liian vaikeaksi.

#### m) (A1) Broken Access Control (WebGoat 2023.4. Pitää olla nimenomaan tämä versio. Eri versioissa on eri tehtävät.)
    - Hijack a session (1) [vaikea]

Kokeilin tutkia tätä tehtävää, mutta se osoittautui itselle liian hankalaksi. 

    - Insecure Direct Object References (4) [vaikeita kohtia]
    - Missing Function Level Access Control (2) [Ei kohtaa 4 "The company fixed the problem, right?", se saattaa olla rikki]


----------------------------------------------------------------------
### Lähteet:
- Try Web Hacking on New Webgoat 2023.4 - https://terokarvinen.com/2023/webgoat-2023-4-ethical-web-hacking/
- Tunkeutumistestaus 2024 - https://terokarvinen.com/2024/eettinen-hakkerointi-2024/
- Pencode - https://github.com/ffuf/pencode
- Zed Attack Proxy https://www.zaproxy.org/
- Using Nested Traversal Sequences to Bypass File Path Traversal Defense - https://kadalonsecurity.medium.com/using-nested-traversal-sequences-to-bypass-file-path-traversal-defense-3982feb4e60b
- Common obstacles to exploiting path traversal vulnerabilities - https://portswigger.net/web-security/file-path-traversal#common-obstacles-to-exploiting-path-traversal-vulnerabilities
- alert() is dead, long live print() - https://portswigger.net/research/alert-is-dead-long-live-print
- 
